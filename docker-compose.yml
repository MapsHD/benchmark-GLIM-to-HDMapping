services:
  glim:
    image: glim2hdmapping:latest
    container_name: glim2hdmapping
    volumes:
      - ${INPUT_BAG_DIRECTORY}:/data:ro
    command: bash -c "source /test_ws/install/setup.sh && ros2 run glim_ros glim_rosbag /data/ --ros-args -p points_topic:=${INPUT_TOPIC:-/livox/pointcloud} & LAUNCH_PID=$$! && echo 'Waiting for GLIM to finish...' && wait $$LAUNCH_PID && echo 'GLIM finished, exiting container...'"
    networks:
      - glim-network
    environment:
      - ROS_DOMAIN_ID=0
    restart: "no"

  bag-recorder:
    image: glim2hdmapping:latest
    container_name: glim2hdmapping-recorder
    volumes:
      - ${INPUT_BAG_DIRECTORY}:/data:ro
      - ${OUTPUT_BASE_DIR}:/out:rw
    command: bash -c "source /test_ws/install/setup.sh && rm -rf /out/${OUTPUT_DIR:-results-glim}/ && echo 'Waiting for GLIM to start...' && timeout 60 bash -c 'until NODES=$$(ros2 node list 2>/dev/null || true) && echo \"$$NODES\" | grep -q glim; do sleep 1; done' && echo 'GLIM started, beginning recording...' && ros2 bag record -o /out/${OUTPUT_DIR:-results-glim} --topics ${RECORD_TOPICS:-/glim_ros/aligned_points_corrected /glim_ros/odom_corrected} & RECORD_PID=$$! && echo 'Monitoring GLIM node...' && while NODES=$$(ros2 node list 2>/dev/null || true) && echo \"$$NODES\" | grep -q glim; do sleep 2; done && echo 'GLIM finished, stopping recorder...' && kill $$RECORD_PID 2>/dev/null && echo 'Recording stopped, exiting container...'"
    networks:
      - glim-network
    environment:
      - ROS_DOMAIN_ID=0
    depends_on:
      - glim
    restart: "no"

networks:
  glim-network:
    driver: bridge
